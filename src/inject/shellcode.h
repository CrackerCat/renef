#pragma once
#include <cstdint>
#include <cstring>
#include <vector>

namespace shellcode {

inline std::vector<uint8_t> arm64_stage1_linjector_exact(uint64_t var_addr,
                                                         uint64_t alloc_len) {
  std::vector<uint8_t> sc = {
      0x26, 0x05, 0x00, 0x58, 0xc1, 0x7c, 0x5f, 0x08, 0xc1, 0xff, 0xff, 0x35,
      0x22, 0x00, 0x80, 0x52, 0xc2, 0x7c, 0x01, 0x08, 0x61, 0xff, 0xff, 0x35,
      0xff, 0x03, 0x04, 0xd1, 0xe0, 0x07, 0x00, 0xa9, 0xe2, 0x0f, 0x01, 0xa9,
      0xe4, 0x17, 0x02, 0xa9, 0xe6, 0x1f, 0x03, 0xa9, 0xe8, 0x27, 0x04, 0xa9,
      0xea, 0x2f, 0x05, 0xa9, 0xec, 0x37, 0x06, 0xa9, 0xee, 0x3f, 0x07, 0xa9,
      0xf0, 0x47, 0x08, 0xa9, 0xf2, 0x4f, 0x09, 0xa9, 0xf4, 0x57, 0x0a, 0xa9,
      0xf6, 0x5f, 0x0b, 0xa9, 0xf8, 0x67, 0x0c, 0xa9, 0xfa, 0x6f, 0x0d, 0xa9,
      0xfc, 0x77, 0x0e, 0xa9, 0xfe, 0x7f, 0x0f, 0xa9, 0x00, 0x00, 0x80, 0xd2,
      0x01, 0x14, 0x80, 0xd2, 0xe2, 0x00, 0x80, 0xd2, 0x43, 0x04, 0x80, 0xd2,
      0xe4, 0x03, 0x3f, 0xaa, 0x05, 0x00, 0x80, 0xd2, 0xc8, 0x1b, 0x80, 0xd2,
      0x01, 0x00, 0x00, 0xd4, 0xc1, 0x01, 0x00, 0x18, 0x01, 0x00, 0x00, 0xb9,
      0x9f, 0x3b, 0x03, 0xd5, 0xdf, 0x3f, 0x03, 0xd5, 0x00, 0x00, 0x40, 0xb2,
      0xc0, 0x00, 0x00, 0xf9, 0x00, 0x00, 0x40, 0xd2, 0x00, 0x00, 0x1f, 0xd6,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x08, 0x5a, 0xe5, 0xa7,
      0x75, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x14,
  };

  uint32_t mov_insn = 0xD2800001 | ((alloc_len & 0xFFFF) << 5);
  sc[96] = (mov_insn & 0xFF);
  sc[97] = ((mov_insn >> 8) & 0xFF);
  sc[98] = ((mov_insn >> 16) & 0xFF);
  sc[99] = ((mov_insn >> 24) & 0xFF);

  for (int i = 0; i < 8; i++) {
    sc[164 + i] = (var_addr >> (i * 8)) & 0xFF;
  }

  for (int i = 0; i < 8; i++) {
    sc[172 + i] = (alloc_len >> (i * 8)) & 0xFF;
  }

  return sc;
}

inline std::vector<uint8_t> arm64_infinite_loop() {
  return {0x00, 0x00, 0x00, 0x14};
}

inline std::vector<uint8_t>
arm64_stage2_dlopen_linjector(uint64_t dlopen_addr, const char *lib_path,
                              uint64_t jmp_back_addr) {
  // Shellcode layout (152 bytes total):
  // 0-3:   adr x0, path (offset 100)
  // 4-7:   ldr x1, dlopen_mode (offset 124, imm19=31)
  // 8-11:  ldr x8, dlopen_addr (offset 128, imm19=32)
  // 12-15: blr x8
  // 16-19: cbz x0, fail
  // 20-83: ldp register restores
  // 84-87: add sp, sp, #256
  // 88-91: ldr x8, jmp_back (offset 144, imm19=18)
  // 92-95: br x8
  // 96-99: brk #1 (fail path)
  // 100-127: path "/data/local/tmp/libagent.so\0" (28 bytes)
  // 128-135: dlopen_mode (RTLD_NOW = 2)
  // 136-143: dlopen_addr
  // 144-151: jmp_back_addr
  std::vector<uint8_t> sc = {
      0x20,
      0x03,
      0x00,
      0x10, // adr x0, #100 (path at 100)
      0xe1,
      0x03,
      0x00,
      0x58, // ldr x1, #124 (mode at 128)
      0x08,
      0x04,
      0x00,
      0x58, // ldr x8, #128 (addr at 136)
      0x00,
      0x01,
      0x3f,
      0xd6, // blr x8
      0x80,
      0x02,
      0x00,
      0xb4, // cbz x0, fail
      0xe0,
      0x07,
      0x40,
      0xa9,
      0xe2,
      0x0f,
      0x41,
      0xa9,
      0xe4,
      0x17,
      0x42,
      0xa9,
      0xe6,
      0x1f,
      0x43,
      0xa9,
      0xe8,
      0x27,
      0x44,
      0xa9,
      0xea,
      0x2f,
      0x45,
      0xa9,
      0xec,
      0x37,
      0x46,
      0xa9,
      0xee,
      0x3f,
      0x47,
      0xa9,
      0xf0,
      0x47,
      0x48,
      0xa9,
      0xf2,
      0x4f,
      0x49,
      0xa9,
      0xf4,
      0x57,
      0x4a,
      0xa9,
      0xf6,
      0x5f,
      0x4b,
      0xa9,
      0xf8,
      0x67,
      0x4c,
      0xa9,
      0xfa,
      0x6f,
      0x4d,
      0xa9,
      0xfc,
      0x77,
      0x4e,
      0xa9,
      0xfe,
      0x7f,
      0x4f,
      0xa9,
      0xff,
      0x03,
      0x04,
      0x91, // add sp, sp, #256
      0xc8,
      0x01,
      0x00,
      0x58, // ldr x8, #56 (back at 144)
      0x00,
      0x01,
      0x1f,
      0xd6, // br x8
      0x20,
      0x00,
      0x20,
      0xd4, // brk #1 (fail)
      // Path: "/data/local/tmp/libagent.so\0" (28 bytes)
      0x2f,
      0x64,
      0x61,
      0x74, // /dat
      0x61,
      0x2f,
      0x6c,
      0x6f, // a/lo
      0x63,
      0x61,
      0x6c,
      0x2f, // cal/
      0x74,
      0x6d,
      0x70,
      0x2f, // tmp/
      0x6c,
      0x69,
      0x62,
      0x61, // liba
      0x67,
      0x65,
      0x6e,
      0x74, // gent
      0x2e,
      0x73,
      0x6f,
      0x00, // .so\0
      // dlopen_mode (RTLD_NOW = 2) at 128
      0x02,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      // dlopen_addr placeholder at 136
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      // jmp_back_addr placeholder at 144
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
  };

  // dlopen_addr at offset 136
  for (int i = 0; i < 8; i++) {
    sc[136 + i] = (dlopen_addr >> (i * 8)) & 0xFF;
  }

  // jmp_back_addr at offset 144
  for (int i = 0; i < 8; i++) {
    sc[144 + i] = (jmp_back_addr >> (i * 8)) & 0xFF;
  }

  (void)lib_path;

  return sc;
}

} // namespace shellcode
